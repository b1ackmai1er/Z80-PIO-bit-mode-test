0001   0000             ;
0002   0000             ; CP/M Z80 HBIOS CIO PIO BIT MODE TEST PROGRAM
0003   0000             ;
0004   0000             ; Version 20-Nov-2018 
0005   0000             ; Phil Summers
0006   0000             ; difficultylevelhigh@gmail.com
0007   0000             ;
0008   0000             ; Default test pattern for each port is:
0009   0000             ; 
0010   0000             ; 1 Toggle all bits on and off. 
0011   0000             ; 2 Toggle each bit on and off.
0012   0000             ; 3 Toggle alternate bits on and off. 
0013   0000             ;
0014   0000             ;
0015   0000             UNIT	.EQU	$07
0016   0000             BDOS	.EQU	0005H
0017   0000             BDOUT	.EQU	09H	
0018   0000             CR	.EQU	0DH
0019   0000             LF	.EQU	0AH
0020   0000             
0021   0100             	.ORG	100H
0022   0100             ;
0023   0100 11 99 01    	LD	DE,MSGBEG	; HELLO
0024   0103 CD 83 01    	CALL	PSTRIN
0025   0106             
0026   0106 06 04       	LD	B,$04		; INIT 
0027   0108 0E 07       	LD	C,UNIT
0028   010A 11 FF FF    	LD	DE,$FFFF
0029   010D             
0030   010D CD 3E 01    	CALL	PAUSE
0031   0110 CD 3E 01    	CALL	PAUSE
0032   0113 CD 3E 01    	CALL	PAUSE
0033   0116 CD 3E 01    	CALL	PAUSE
0034   0119             ;
0035   0119             ; DISPLAY TEST PATTERN
0036   0119             ;
0037   0119 21 DB 01    	LD	HL,TSTBEG
0038   011C 06 19       	LD	B,TSTPAT-TSTBEG
0039   011E 7E          LP2:	LD	A,(HL)
0040   011F CD 5D 01    	CALL	OUTB
0041   0122 CD 4C 01    	CALL	OUTSPC
0042   0125             ;
0043   0125 7E          	LD	A,(HL)
0044   0126 5F          	LD	E,A
0045   0127             ;
0046   0127 C5          	PUSH	BC
0047   0128             ;	LD	E,$00
0048   0128 06 01       	LD	B,$01
0049   012A 0E 07       	LD	C,UNIT
0050   012C CF          	RST	08
0051   012D C1          	POP	BC
0052   012E CD 3E 01    	CALL	PAUSE
0053   0131 CD 3E 01    	CALL	PAUSE
0054   0134             ;
0055   0134 23          	INC	HL
0056   0135 10 E7       	DJNZ	LP2
0057   0137             ;
0058   0137 11 BD 01    BYE:	LD	DE,MSGEND	; GOODBYE
0059   013A CD 83 01    	CALL	PSTRIN	
0060   013D C9          	RET
0061   013E             ;
0062   013E             ; PAUSE
0063   013E             ;
0064   013E D5          PAUSE:	PUSH	DE
0065   013F C5          	PUSH	BC	
0066   0140 16 FF          	LD      D,0FFH
0067   0142 06 FF       LP3:    LD      B,0FFH
0068   0144 10 FE       LP4:	DJNZ    LP4
0069   0146 15                  DEC     D
0070   0147 20 F9               JR      NZ,LP3
0071   0149 C1                  POP	BC
0072   014A D1                  POP	DE
0073   014B C9          	RET
0074   014C             ;
0075   014C             ; OUTPUT SPACE
0076   014C             ;
0077   014C 1E 20       OUTSPC:	LD	E,20H
0078   014E CD 7E 01    	CALL	PCHAR
0079   0151 C9          	RET
0080   0152             ;
0081   0152             ; OUTPUT CR+LF
0082   0152             ;
0083   0152 1E 0D       CRLF:	LD	E,CR
0084   0154 CD 7E 01    	CALL	PCHAR
0085   0157 1E 0A       	LD	E,LF
0086   0159 CD 7E 01    	CALL	PCHAR
0087   015C C9          	RET
0088   015D             ;
0089   015D             ; OUTPUT BYTE A
0090   015D             ;	
0091   015D F5          OUTB:	PUSH	AF
0092   015E 0F          	RRCA
0093   015F 0F          	RRCA
0094   0160 0F          	RRCA
0095   0161 0F          	RRCA
0096   0162 E6 0F       	AND	0FH
0097   0164 CD 71 01    	CALL	HBTHE
0098   0167 F1          	POP	AF
0099   0168 E6 0F       	AND	0FH
0100   016A CD 71 01    	CALL	HBTHE
0101   016D CD 4C 01    	CALL	OUTSPC
0102   0170 C9          	RET
0103   0171             ;
0104   0171             ;Output HALF-BYTE
0105   0171             ;****************
0106   0171             ;
0107   0171             ;PARAMETER: Entry Half-BYTE IN A (BIT 0 - 3)
0108   0171             ;*********
0109   0171             ;
0110   0171 FE 0A       HBTHE:	CP 	0AH
0111   0173 38 02       	JR	C,HBTHE1
0112   0175 C6 07       	ADD	A,7
0113   0177 C6 30       HBTHE1:	ADD	A,30H
0114   0179 5F          	LD	E,A
0115   017A CD 7E 01    	CALL	PCHAR
0116   017D C9          	RET
0117   017E             ;
0118   017E             ; PRINT A CHARACTER 
0119   017E             ;
0120   017E C5          PCHAR:	PUSH	BC
0121   017F 0E 02       	LD	C,02H
0122   0181 18 05       	JR	BDO
0123   0183 C5          PSTRIN:	PUSH	BC
0124   0184 0E 09       	LD	C,09H
0125   0186 18 00       	JR	BDO
0126   0188             ;
0127   0188             ; CP/M BDOS CALL
0128   0188             ;
0129   0188 E5          BDO:	PUSH	HL
0130   0189 D5          	PUSH	DE
0131   018A DD E5       	PUSH	IX
0132   018C FD E5       	PUSH	IY
0133   018E CD 05 00    	CALL	BDOS
0134   0191 FD E1       	POP	IY
0135   0193 DD E1       	POP	IX
0136   0195 D1          	POP	DE
0137   0196 E1          	POP	HL
0138   0197 C1          	POP	BC
0139   0198 C9          	RET
0140   0199             
0141   0199 43 50 2F 4D MSGBEG:	.DB	"CP/M Z80 HBIOS PIO BIT MODE TEST.",CR,LF,"$"
0141   019D 20 5A 38 30 
0141   01A1 20 48 42 49 
0141   01A5 4F 53 20 50 
0141   01A9 49 4F 20 42 
0141   01AD 49 54 20 4D 
0141   01B1 4F 44 45 20 
0141   01B5 54 45 53 54 
0141   01B9 2E 0D 0A 24 
0142   01BD 0D 0A 54 45 MSGEND:	.DB	CR,LF,"TEST COMPLETE.",CR,LF,"$"
0142   01C1 53 54 20 43 
0142   01C5 4F 4D 50 4C 
0142   01C9 45 54 45 2E 
0142   01CD 0D 0A 24 
0143   01D0 50 49 4F 20 PIONUM:	.DB	"PIO $"
0143   01D4 24 
0144   01D5 50 4F 52 54 PORTNUM:.DB	"PORT $"
0144   01D9 20 24 
0145   01DB             
0146   01DB             TSTBEG	.EQU	$
0147   01DB FF          	.DB	0FFH
0148   01DC 55                  .DB      55H
0149   01DD AA                  .DB      0AAH
0150   01DE 55                  .DB      55H
0151   01DF AA                  .DB      0AAH
0152   01E0 55          	.DB	55H
0153   01E1 AA          	.DB	0AAH
0154   01E2 55          	.DB	55H
0155   01E3 AA          	.DB	0AAH
0156   01E4 00          	.DB	00H
0157   01E5 01          	.DB	01H
0158   01E6 02          	.DB	02H
0159   01E7 04          	.DB	04H
0160   01E8 08          	.DB	08H
0161   01E9 10          	.DB	10H
0162   01EA 20          	.DB	20H
0163   01EB 40          	.DB	40H
0164   01EC 80          	.DB	80H
0165   01ED 00          	.DB	00H
0166   01EE FF          	.DB	0FFH
0167   01EF 00          	.DB	00H
0168   01F0 FF          	.DB	0FFH
0169   01F1 00          	.DB	00H
0170   01F2 FF          	.DB	0FFH
0171   01F3 00          	.DB	00H
0172   01F4 FF          TSTPAT:	.DB	0FFH	
0173   01F5             
0174   01F5                     .END
tasm: Number of errors = 0
